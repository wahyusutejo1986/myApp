<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Family - Family To-Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .family-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .task-item {
            transition: all 0.2s ease;
        }
        
        .task-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        .family-member {
            transition: all 0.2s ease;
        }
        
        .family-member:hover {
            transform: scale(1.05);
        }
        
        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #10b981; }

        .loading-overlay {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 loading-overlay flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading your family tasks...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="family-gradient text-white shadow-lg">
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-white bg-opacity-20 rounded-full p-2">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Lucky Family</h1>
                        <p class="text-white text-opacity-80 text-sm" id="familyName">Loading...</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm bg-white bg-opacity-20 px-3 py-1 rounded-full">
                        <span id="taskCount">0</span> tasks today
                    </span>
                    <div class="relative">
                        <button id="userMenuBtn" class="flex items-center space-x-2 bg-white bg-opacity-20 px-3 py-2 rounded-lg hover:bg-opacity-30 transition-all">
                            <div class="w-8 h-8 bg-white bg-opacity-30 rounded-full flex items-center justify-center">
                                <span id="userInitial" class="text-sm font-semibold">U</span>
                            </div>
                            <span id="userName" class="text-sm">User</span>
                        </button>
                        <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 z-10">
                            <button id="logoutBtn" class="w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100 transition-colors">
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Family Members Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                        </svg>
                        Family Members
                    </h2>
                    <div class="space-y-3" id="familyMembers">
                        <!-- Family members will be loaded here -->
                    </div>
                    
                    <!-- Add Member Button -->
                    <button id="addMemberBtn" class="w-full mt-4 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg text-sm font-medium transition-colors">
                        + Add Family Member
                    </button>
                </div>

                <!-- Pet Care Dashboard -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="text-xl mr-2">üêæ</span>
                        Pet Care
                    </h3>
                    <div class="space-y-4" id="petProfiles">
                        <!-- Pet profiles will be loaded here -->
                    </div>
                    
                    <!-- Add Pet Button -->
                    <button id="addPetBtn" class="w-full mt-4 bg-orange-100 hover:bg-orange-200 text-orange-700 py-2 px-4 rounded-lg text-sm font-medium transition-colors">
                        + Add Pet
                    </button>
                </div>

                <!-- Quick Stats -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Today's Progress</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Completed</span>
                            <span class="font-semibold text-green-600" id="completedCount">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Pending</span>
                            <span class="font-semibold text-orange-600" id="pendingCount">0</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%" id="progressBar"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main To-Do List -->
            <div class="lg:col-span-2">
                <!-- Add Task Form -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Add New Task</h2>
                    <form id="taskForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="taskInput" placeholder="What needs to be done?" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <select id="assigneeSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <!-- Options will be populated from database -->
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <select id="prioritySelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="low">Low Priority</option>
                                <option value="medium" selected>Medium Priority</option>
                                <option value="high">High Priority</option>
                            </select>
                            <input type="date" id="dueDateInput" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <input type="time" id="dueTimeInput" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <textarea id="taskDescription" placeholder="Additional details (optional)" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" rows="2"></textarea>
                        <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 px-6 rounded-lg hover:from-purple-700 hover:to-blue-700 transition-all duration-200 font-medium">
                            <span id="addTaskBtnText">Add Task</span>
                            <svg id="addTaskSpinner" class="hidden animate-spin -ml-1 mr-3 h-4 w-4 text-white inline" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </form>
                </div>

                <!-- View Toggle -->
                <div class="flex items-center justify-between mb-6">
                    <div class="flex gap-2">
                        <button id="listViewBtn" class="view-btn bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium">üìã List View</button>
                        <button id="calendarViewBtn" class="view-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300">üìÖ Calendar View</button>
                    </div>
                    <div id="calendarNav" class="hidden flex items-center gap-3">
                        <button id="prevMonth" class="p-2 hover:bg-gray-100 rounded-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h3 id="currentMonth" class="text-lg font-semibold text-gray-800 min-w-[140px] text-center"></h3>
                        <button id="nextMonth" class="p-2 hover:bg-gray-100 rounded-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Filter Buttons -->
                <div id="filterButtons" class="flex flex-wrap gap-2 mb-6">
                    <button class="filter-btn bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium" data-filter="all">All Tasks</button>
                    <button class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300" data-filter="pending">Pending</button>
                    <button class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300" data-filter="completed">Completed</button>
                    <button class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300" data-filter="high">High Priority</button>
                    <button class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300" data-filter="today">Due Today</button>
                </div>

                <!-- Tasks List -->
                <div class="space-y-3" id="tasksList">
                    <!-- Tasks will be dynamically loaded here -->
                </div>

                <!-- Calendar View -->
                <div id="calendarView" class="hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <!-- Calendar Header -->
                        <div class="grid grid-cols-7 bg-gray-50 border-b">
                            <div class="p-3 text-center text-sm font-semibold text-gray-700 border-r">Sun</div>
                            <div class="p-3 text-center text-sm font-semibold text-gray-700 border-r">Mon</div>
                            <div class="p-3 text-center text-sm font-semibold text-gray-700 border-r">Tue</div>
                            <div class="p-3 text-center text-sm font-semibold text-gray-700 border-r">Wed</div>
                            <div class="p-3 text-center text-sm font-semibold text-gray-700 border-r">Thu</div>
                            <div class="p-3 text-center text-sm font-semibold text-gray-700 border-r">Fri</div>
                            <div class="p-3 text-center text-sm font-semibold text-gray-700">Sat</div>
                        </div>
                        <!-- Calendar Grid -->
                        <div id="calendarGrid" class="grid grid-cols-7">
                            <!-- Calendar days will be dynamically added here -->
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden text-center py-12 bg-white rounded-xl shadow-sm border border-gray-200">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-500 mb-2">No tasks found</h3>
                    <p class="text-gray-400">Add your first family task to get started!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Add Family Member</h3>
            <form id="addMemberForm" class="space-y-4">
                <input type="text" id="memberName" placeholder="Member name" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                <select id="memberRole" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="Mom">Mom</option>
                    <option value="Dad">Dad</option>
                    <option value="Kids">Kids</option>
                    <option value="Everyone">Everyone</option>
                </select>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">Add Member</button>
                    <button type="button" id="cancelAddMember" class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Pet Modal -->
    <div id="addPetModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Add Pet</h3>
            <form id="addPetForm" class="space-y-4">
                <input type="text" id="petName" placeholder="Pet name" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                <select id="petType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="dog">üêï Dog</option>
                    <option value="cat">üê± Cat</option>
                    <option value="bird">üê¶ Bird</option>
                    <option value="fish">üê† Fish</option>
                    <option value="other">üêæ Other</option>
                </select>
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="petAgeYears" placeholder="Age (years)" min="0" max="30"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <input type="number" id="petAgeMonths" placeholder="Months" min="0" max="11"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">Add Pet</button>
                    <button type="button" id="cancelAddPet" class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        // Replace with your actual Supabase URL and anon key
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let currentUser = null;
        let currentFamily = null;
        let familyMembers = [];
        let tasks = [];
        let pets = [];
        let currentFilter = 'all';
        let currentView = 'list';
        let currentDate = new Date();

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthAndInitialize();
            setupEventListeners();
        });

        async function checkAuthAndInitialize() {
            try {
                // Check if user is authenticated
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error || !user) {
                    window.location.href = 'login.html';
                    return;
                }

                currentUser = user;
                
                // Load user's family and initialize app
                await loadUserFamily();
                await loadFamilyMembers();
                await loadPets();
                await loadTasks();
                
                updateUI();
                hideLoadingOverlay();
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to load app. Please refresh the page.');
                hideLoadingOverlay();
            }
        }

        async function loadUserFamily() {
            try {
                // First, check if user is already a family member
                const { data: memberData, error: memberError } = await supabase
                    .from('family_members')
                    .select('family_id, families(name)')
                    .eq('member_id', currentUser.id)
                    .single();

                if (memberData) {
                    currentFamily = { id: memberData.family_id, name: memberData.families.name };
                } else {
                    // Create new family for user
                    const familyName = currentUser.user_metadata?.family_name || `${currentUser.user_metadata?.full_name || 'User'}'s Family`;
                    
                    const { data: familyData, error: familyError } = await supabase
                        .from('families')
                        .insert([{ name: familyName }])
                        .select()
                        .single();

                    if (familyError) throw familyError;

                    currentFamily = familyData;

                    // Add user as first family member
                    const { error: memberInsertError } = await supabase
                        .from('family_members')
                        .insert([{
                            family_id: currentFamily.id,
                            name: currentUser.user_metadata?.full_name || 'User',
                            role: 'Mom', // Default role
                            member_id: currentUser.id
                        }]);

                    if (memberInsertError) throw memberInsertError;
                }

                document.getElementById('familyName').textContent = currentFamily.name;
                document.getElementById('userName').textContent = currentUser.user_metadata?.full_name || 'User';
                document.getElementById('userInitial').textContent = (currentUser.user_metadata?.full_name || 'U')[0].toUpperCase();

            } catch (error) {
                console.error('Error loading family:', error);
                throw error;
            }
        }

        async function loadFamilyMembers() {
            try {
                const { data, error } = await supabase
                    .from('family_members')
                    .select('*')
                    .eq('family_id', currentFamily.id)
                    .eq('is_active', true)
                    .order('created_at');

                if (error) throw error;

                familyMembers = data || [];
                renderFamilyMembers();
                populateAssigneeSelect();

            } catch (error) {
                console.error('Error loading family members:', error);
                showError('Failed to load family members');
            }
        }

        async function loadPets() {
            try {
                const { data, error } = await supabase
                    .from('pet_profiles')
                    .select('*')
                    .eq('family_id', currentFamily.id)
                    .eq('is_active', true)
                    .order('created_at');

                if (error) throw error;

                pets = data || [];
                renderPets();

            } catch (error) {
                console.error('Error loading pets:', error);
                showError('Failed to load pets');
            }
        }

        async function loadTasks() {
            try {
                const { data, error } = await supabase
                    .from('tasks')
                    .select(`
                        *,
                        assignee:family_members(name, role, color),
                        created_by_member:family_members!tasks_created_by_fkey(name)
                    `)
                    .eq('family_id', currentFamily.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                tasks = data || [];
                renderTasks();
                updateStats();

            } catch (error) {
                console.error('Error loading tasks:', error);
                showError('Failed to load tasks');
            }
        }

        function renderFamilyMembers() {
            const container = document.getElementById('familyMembers');
            const memberColors = {
                'Mom': 'from-blue-100 to-blue-200 border-blue-300 bg-blue-600',
                'Dad': 'from-green-100 to-green-200 border-green-300 bg-green-600',
                'Kids': 'from-pink-100 to-pink-200 border-pink-300 bg-pink-600',
                'Everyone': 'from-purple-100 to-purple-200 border-purple-300 bg-purple-600'
            };

            container.innerHTML = familyMembers.map(member => {
                const colors = memberColors[member.role] || 'from-gray-100 to-gray-200 border-gray-300 bg-gray-600';
                const [gradientColors, borderColor, bgColor] = colors.split(' ');
                const memberTasks = tasks.filter(t => t.assignee_id === member.id && t.status === 'pending').length;

                return `
                    <div class="family-member bg-gradient-to-r ${gradientColors} p-3 rounded-lg cursor-pointer border-2 border-transparent" data-member="${member.id}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 ${bgColor} rounded-full flex items-center justify-center text-white font-medium text-sm">
                                    ${member.name[0].toUpperCase()}
                                </div>
                                <div>
                                    <span class="font-semibold text-gray-900">${member.name}</span>
                                    <div class="text-xs text-gray-600">${member.role}</div>
                                </div>
                            </div>
                            <span class="text-xs ${bgColor} text-white px-2 py-1 rounded-full font-medium">${memberTasks} tasks</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPets() {
            const container = document.getElementById('petProfiles');
            
            if (pets.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No pets added yet</p>';
                return;
            }

            const petEmojis = {
                'dog': 'üêï',
                'cat': 'üê±',
                'bird': 'üê¶',
                'fish': 'üê†',
                'other': 'üêæ'
            };

            container.innerHTML = pets.map(pet => `
                <div class="bg-gradient-to-r from-orange-100 to-orange-200 p-3 rounded-lg border border-orange-300">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold text-gray-900">${petEmojis[pet.type]} ${pet.name}</span>
                        <span class="text-xs bg-orange-600 text-white px-2 py-1 rounded-full font-medium">
                            ${pet.age_years || 0}y ${pet.age_months || 0}m
                        </span>
                    </div>
                    <div class="text-sm text-gray-800">
                        <div>Type: <span class="font-medium capitalize">${pet.type}</span></div>
                    </div>
                </div>
            `).join('');
        }

        function populateAssigneeSelect() {
            const select = document.getElementById('assigneeSelect');
            select.innerHTML = familyMembers.map(member => 
                `<option value="${member.id}">${member.name} (${member.role})</option>`
            ).join('');
        }

        function renderTasks() {
            const tasksList = document.getElementById('tasksList');
            const emptyState = document.getElementById('emptyState');
            
            let filteredTasks = getFilteredTasks();
            
            if (filteredTasks.length === 0) {
                tasksList.style.display = 'none';
                emptyState.classList.remove('hidden');
                return;
            }
            
            tasksList.style.display = 'block';
            emptyState.classList.add('hidden');
            
            const memberColors = {
                'Mom': 'bg-blue-100 border-blue-300 bg-blue-600',
                'Dad': 'bg-green-100 border-green-300 bg-green-600',
                'Kids': 'bg-pink-100 border-pink-300 bg-pink-600',
                'Everyone': 'bg-purple-100 border-purple-300 bg-purple-600'
            };

            tasksList.innerHTML = filteredTasks.map(task => {
                const assignee = task.assignee || { name: 'Unassigned', role: 'None' };
                const colors = memberColors[assignee.role] || 'bg-gray-100 border-gray-300 bg-gray-600';
                const [bgColor, borderColor, badgeColor] = colors.split(' ');
                
                const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString() : '';
                const dueTime = task.due_time || '';
                
                return `
                    <div class="task-item bg-white rounded-lg shadow-sm border ${borderColor} p-4 priority-${task.priority} ${task.status === 'completed' ? 'completed' : ''}">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-3 flex-1">
                                <input type="checkbox" ${task.status === 'completed' ? 'checked' : ''} 
                                       onchange="toggleTask('${task.id}')"
                                       class="mt-1 w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                <div class="flex-1">
                                    <p class="text-gray-900 font-semibold ${task.status === 'completed' ? 'line-through text-gray-600' : ''}">${task.title}</p>
                                    ${task.description ? `<p class="text-sm text-gray-600 mt-1">${task.description}</p>` : ''}
                                    <div class="flex items-center space-x-3 mt-2">
                                        <span class="text-xs px-2 py-1 rounded-full font-medium text-white ${badgeColor}">${assignee.name}</span>
                                        <span class="text-xs px-2 py-1 rounded-full font-medium ${
                                            task.priority === 'high' ? 'bg-red-600 text-white' :
                                            task.priority === 'medium' ? 'bg-yellow-600 text-white' :
                                            'bg-green-600 text-white'
                                        }">${task.priority} priority</span>
                                        ${dueDate ? `<span class="text-xs text-gray-700 font-medium">Due: ${dueDate} ${dueTime}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <button onclick="deleteTask('${task.id}')" 
                                    class="text-gray-400 hover:text-red-500 transition-colors ml-4">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getFilteredTasks() {
            let filteredTasks = tasks;
            
            switch(currentFilter) {
                case 'pending':
                    filteredTasks = tasks.filter(t => t.status === 'pending');
                    break;
                case 'completed':
                    filteredTasks = tasks.filter(t => t.status === 'completed');
                    break;
                case 'high':
                    filteredTasks = tasks.filter(t => t.priority === 'high');
                    break;
                case 'today':
                    const today = new Date().toISOString().split('T')[0];
                    filteredTasks = tasks.filter(t => t.due_date === today);
                    break;
            }
            
            return filteredTasks;
        }

        function updateStats() {
            const completed = tasks.filter(t => t.status === 'completed').length;
            const pending = tasks.filter(t => t.status === 'pending').length;
            const total = tasks.length;
            
            document.getElementById('taskCount').textContent = total;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('pendingCount').textContent = pending;
            
            const progressPercentage = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progressBar').style.width = progressPercentage + '%';
        }

        async function addTask(e) {
            e.preventDefault();
            
            const title = document.getElementById('taskInput').value.trim();
            const assigneeId = document.getElementById('assigneeSelect').value;
            const priority = document.getElementById('prioritySelect').value;
            const dueDate = document.getElementById('dueDateInput').value || null;
            const dueTime = document.getElementById('dueTimeInput').value || null;
            const description = document.getElementById('taskDescription').value.trim() || null;
            
            if (!title) return;
            
            setButtonLoading('addTask', true);
            
            try {
                const { data, error } = await supabase
                    .from('tasks')
                    .insert([{
                        family_id: currentFamily.id,
                        title: title,
                        description: description,
                        assignee_id: assigneeId,
                        priority: priority,
                        due_date: dueDate,
                        due_time: dueTime,
                        created_by: getCurrentUserMemberId()
                    }])
                    .select(`
                        *,
                        assignee:family_members(name, role, color),
                        created_by_member:family_members!tasks_created_by_fkey(name)
                    `)
                    .single();

                if (error) throw error;

                tasks.unshift(data);
                document.getElementById('taskForm').reset();
                document.getElementById('dueDateInput').value = new Date().toISOString().split('T')[0];
                
                renderTasks();
                updateStats();
                renderFamilyMembers();
                
                showSuccess('Task added successfully!');

            } catch (error) {
                console.error('Error adding task:', error);
                showError('Failed to add task. Please try again.');
            } finally {
                setButtonLoading('addTask', false);
            }
        }

        async function toggleTask(taskId) {
            try {
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                const newStatus = task.status === 'completed' ? 'pending' : 'completed';
                const updateData = {
                    status: newStatus,
                    updated_at: new Date().toISOString()
                };

                if (newStatus === 'completed') {
                    updateData.completed_at = new Date().toISOString();
                    updateData.completed_by = getCurrentUserMemberId();
                } else {
                    updateData.completed_at = null;
                    updateData.completed_by = null;
                }

                const { error } = await supabase
                    .from('tasks')
                    .update(updateData)
                    .eq('id', taskId);

                if (error) throw error;

                // Update local task
                Object.assign(task, updateData);
                
                renderTasks();
                updateStats();
                renderFamilyMembers();

            } catch (error) {
                console.error('Error toggling task:', error);
                showError('Failed to update task status');
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;

            try {
                const { error } = await supabase
                    .from('tasks')
                    .delete()
                    .eq('id', taskId);

                if (error) throw error;

                tasks = tasks.filter(t => t.id !== taskId);
                renderTasks();
                updateStats();
                renderFamilyMembers();
                
                showSuccess('Task deleted successfully!');

            } catch (error) {
                console.error('Error deleting task:', error);
                showError('Failed to delete task');
            }
        }

        async function addFamilyMember(e) {
            e.preventDefault();
            
            const name = document.getElementById('memberName').value.trim();
            const role = document.getElementById('memberRole').value;
            
            if (!name) return;
            
            try {
                const { data, error } = await supabase
                    .from('family_members')
                    .insert([{
                        family_id: currentFamily.id,
                        name: name,
                        role: role
                    }])
                    .select()
                    .single();

                if (error) throw error;

                familyMembers.push(data);
                renderFamilyMembers();
                populateAssigneeSelect();
                closeModal('addMemberModal');
                document.getElementById('addMemberForm').reset();
                
                showSuccess('Family member added successfully!');

            } catch (error) {
                console.error('Error adding family member:', error);
                showError('Failed to add family member');
            }
        }

        async function addPet(e) {
            e.preventDefault();
            
            const name = document.getElementById('petName').value.trim();
            const type = document.getElementById('petType').value;
            const ageYears = parseInt(document.getElementById('petAgeYears').value) || 0;
            const ageMonths = parseInt(document.getElementById('petAgeMonths').value) || 0;
            
            if (!name) return;
            
            try {
                const { data, error } = await supabase
                    .from('pet_profiles')
                    .insert([{
                        family_id: currentFamily.id,
                        name: name,
                        type: type,
                        age_years: ageYears,
                        age_months: ageMonths
                    }])
                    .select()
                    .single();

                if (error) throw error;

                pets.push(data);
                renderPets();
                closeModal('addPetModal');
                document.getElementById('addPetForm').reset();
                
                showSuccess('Pet added successfully!');

            } catch (error) {
                console.error('Error adding pet:', error);
                showError('Failed to add pet');
            }
        }

        function setupEventListeners() {
            // Task form
            document.getElementById('taskForm').addEventListener('submit', addTask);
            
            // Set today's date as default
            document.getElementById('dueDateInput').value = new Date().toISOString().split('T')[0];
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentFilter = this.dataset.filter;
                    updateFilterButtons();
                    renderTasks();
                });
            });
            
            // View toggle buttons
            document.getElementById('listViewBtn').addEventListener('click', () => switchView('list'));
            document.getElementById('calendarViewBtn').addEventListener('click', () => switchView('calendar'));
            
            // User menu
            document.getElementById('userMenuBtn').addEventListener('click', toggleUserMenu);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Modal buttons
            document.getElementById('addMemberBtn').addEventListener('click', () => openModal('addMemberModal'));
            document.getElementById('addPetBtn').addEventListener('click', () => openModal('addPetModal'));
            document.getElementById('cancelAddMember').addEventListener('click', () => closeModal('addMemberModal'));
            document.getElementById('cancelAddPet').addEventListener('click', () => closeModal('addPetModal'));
            
            // Modal forms
            document.getElementById('addMemberForm').addEventListener('submit', addFamilyMember);
            document.getElementById('addPetForm').addEventListener('submit', addPet);
            
            // Close modals when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('fixed') && e.target.classList.contains('inset-0')) {
                    const modals = ['addMemberModal', 'addPetModal'];
                    modals.forEach(modalId => {
                        if (!document.getElementById(modalId).classList.contains('hidden')) {
                            closeModal(modalId);
                        }
                    });
                }
            });
        }

        function updateUI() {
            renderFamilyMembers();
            renderPets();
            renderTasks();
            updateStats();
            populateAssigneeSelect();
        }

        function updateFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === currentFilter) {
                    btn.className = 'filter-btn bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium';
                } else {
                    btn.className = 'filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300';
                }
            });
        }

        function switchView(view) {
            currentView = view;
            // View switching logic would go here
            // For now, just update button states
            const listBtn = document.getElementById('listViewBtn');
            const calendarBtn = document.getElementById('calendarViewBtn');
            
            if (view === 'list') {
                listBtn.className = 'view-btn bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium';
                calendarBtn.className = 'view-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300';
            } else {
                listBtn.className = 'view-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-300';
                calendarBtn.className = 'view-btn bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium';
            }
        }

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('hidden');
        }

        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error logging out:', error);
                showError('Failed to log out');
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function setButtonLoading(buttonType, isLoading) {
            const btn = document.getElementById(`${buttonType}Btn`);
            const btnText = document.getElementById(`${buttonType}BtnText`);
            const spinner = document.getElementById(`${buttonType}Spinner`);
            
            if (btn) btn.disabled = isLoading;
            
            if (isLoading) {
                if (btnText) btnText.textContent = 'Please wait...';
                if (spinner) spinner.classList.remove('hidden');
            } else {
                if (spinner) spinner.classList.add('hidden');
                if (btnText) {
                    switch(buttonType) {
                        case 'addTask':
                            btnText.textContent = 'Add Task';
                            break;
                    }
                }
            }
        }

        function getCurrentUserMemberId() {
            const member = familyMembers.find(m => m.member_id === currentUser.id);
            return member ? member.id : null;
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showSuccess(message) {
            // You can implement a toast notification system here
            console.log('Success:', message);
        }

        function showError(message) {
            // You can implement a toast notification system here
            console.error('Error:', message);
            alert(message); // Temporary error display
        }

        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                window.location.href = 'login.html';
            }
        });

        // Close user menu when clicking outside
        document.addEventListener('click', function(e) {
            const userMenu = document.getElementById('userMenu');
            const userMenuBtn = document.getElementById('userMenuBtn');
            
            if (!userMenuBtn.contains(e.target) && !userMenu.contains(e.target)) {
                userMenu.classList.add('hidden');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9626a04cb1115e40',t:'MTc1MzA1ODIwOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
